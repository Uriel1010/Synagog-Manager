{% extends "base.html" %}
{% from "_form_helpers.html" import render_field, render_submit %}

{% block content %}
<div class="container mt-4">
    <h2>Scanning for: {{ event.event_name }} ({{ event.gregorian_date.strftime('%Y-%m-%d') }})</h2>
    <hr>

    <div class="row">
        <div class="col-md-6">
            <h4>Camera Feed</h4>
            <div id="scanner-container" style="position: relative; width: 100%; max-width: 500px; border: 1px solid grey;">
                 <video id="camera-feed" playsinline muted style="width: 100%; height: auto;" ></video>
                 <!-- Optional: Canvas overlay for drawing detection boxes -->
            </div>
            <div class="mt-2">
                <button id="start-scan-btn" class="btn btn-primary">Start Camera</button>
                <button id="stop-scan-btn" class="btn btn-secondary" style="display: none;">Stop Camera</button>
            </div>
             <p id="camera-error" class="text-danger mt-2"></p>
        </div>

        <div class="col-md-6">
            <h4>Current Status</h4>
            <div class="card mb-3">
                <div class="card-body">
                    <p><strong>Event:</strong> {{ event.event_name }}</p>
                    <p><strong>Current Buyer:</strong> <span id="current-buyer">None</span></p>
                    <p><strong>Current Item:</strong> <span id="current-item">None</span></p>
                    <p><strong>Accumulated Price:</strong> ₪<span id="accumulated-price">0.00</span></p>
                    <hr>
                    <p><strong>Status Message:</strong></p>
                    <div id="status-message" class="alert alert-info" role="alert">
                        Ready to scan Buyer...
                    </div>
                </div>
            </div>

            <!-- Toggle Button for Manual Entry -->
            <button id="toggle-manual-form" class="btn btn-secondary mb-3">Manual Entry</button>

            <!-- Manual Entry Form (initially hidden) -->
            <div id="manual-form" style="display: none;">
                <h4>Enter Purchase Manually</h4>
                <form method="POST" action="{{ url_for('scanning.manual_entry') }}">
                    {{ manual_form.hidden_tag() }}
                    <div class="mb-3">
                        {{ render_field(manual_form.buyer_id) }}
                    </div>
                    <div class="mb-3">
                        {{ render_field(manual_form.item_id) }}
                    </div>
                    <div class="mb-3">
                        {{ render_field(manual_form.total_price, placeholder='Enter price in ₪') }}
                    </div>
                    <div class="mb-3">
                        {{ render_field(manual_form.quantity, placeholder='Enter quantity') }}
                    </div>
                    <div class="mb-3">
                        {{ render_field(manual_form.manual_entry_notes, placeholder='Any additional notes') }}
                    </div>
                    <button type="submit" class="btn btn-primary">Submit Purchase</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Button to finish scanning session -->
    <div class="mt-3">
        <form method="POST" action="{{ url_for('scanning.finish_event') }}" onsubmit="return confirm('Finish scanning for this event? Any pending item will be saved.');">
            {#{ csrf_token() }#}
            <button type="submit" class="btn btn-success">Finish Event Scanning</button>
        </form>
    </div>
</div>

<script>
// Toggle manual entry form display
document.getElementById("toggle-manual-form").addEventListener("click", function() {
    var formDiv = document.getElementById("manual-form");
    if (formDiv.style.display === "none") {
        formDiv.style.display = "block";
        this.textContent = "Hide Manual Entry";
    } else {
        formDiv.style.display = "none";
        this.textContent = "Manual Entry";
    }
});
</script>
{% endblock %}

{% extends "base.html" %}
{% from "_form_helpers.html" import render_submit %}

{% block content %}
<div class="container mt-4">
  <!-- Event header -->
  <div class="d-flex flex-wrap align-items-center mb-3">
    <h2 class="me-3">
      Scanning for: {{ event.event_name }} ({{ event.gregorian_date.strftime('%Y-%m-%d') }})
    </h2>
    <a href="{{ url_for('main.edit_event', event_id=event.id) }}" class="btn btn-outline-secondary btn-sm me-1 mb-1">Edit</a>
    <form method="POST"
          action="{{ url_for('main.delete_event', event_id=event.id) }}"
          onsubmit="return confirm('Delete this event and ALL its purchases?');"
          class="d-inline mb-1">
      {{ delete_event_form.hidden_tag() }}
      <button class="btn btn-outline-danger btn-sm">Delete</button>
    </form>
    <a href="{{ url_for('main.create_event') }}" class="btn btn-outline-primary btn-sm ms-auto mb-1">+ New Event</a>
  </div>
  <hr>

  <div class="row">
    <!-- Camera Feed -->
    <div class="col-12 col-md-6 mb-4">
      <h4>Camera Feed</h4>
      <div id="scanner-container" class="border p-2">
        <video id="camera-feed" playsinline muted class="w-100"></video>
      </div>
      <div class="mt-2">
        <button id="start-scan-btn" class="btn btn-primary me-1">Start Camera</button>
        <button id="stop-scan-btn" class="btn btn-secondary" style="display:none;">Stop Camera</button>
      </div>
      <p id="camera-error" class="text-danger mt-2"></p>
    </div>

    <!-- Status panel -->
    <div class="col-12 col-md-6 mb-4">
      <h4>Status</h4>
      <div class="card mb-3">
        <div class="card-body">
          <p><strong>Buyer:</strong> <span id="current-buyer">None</span></p>
          <p><strong>Item:</strong> <span id="current-item">None</span></p>
          <p><strong>Accumulated:</strong> ₪<span id="accumulated-price">0.00</span></p>
          <div id="status-message" class="alert alert-info mt-2">
            Ready to scan buyer.
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Manual entry (responsive grid) -->
  <h5>Manual Entry</h5>
  <form id="manual-entry-form"
        method="POST"
        action="{{ url_for('scanning.manual_entry') }}">
    {{ manual_form.hidden_tag() }}
    <div class="row g-2 align-items-end mb-4">
      <div class="col-12 col-sm-6 col-md-2">
        <label for="manual-buyer-id" class="form-label">Buyer</label>
        <div class="d-flex">
          {{ manual_form.buyer_id(class="form-select form-select-sm w-100", id="manual-buyer-id") }}
          <button id="add-buyer-btn" type="button"
                  class="btn btn-outline-secondary btn-sm ms-1">+</button>
        </div>
        <div id="add-buyer-form" class="mt-1" style="display:none;">
          <input type="text" id="new-buyer-name"
                 class="form-control form-control-sm"
                 placeholder="New buyer name">
          <div class="mt-1">
            <button id="save-buyer-btn" type="button" class="btn btn-sm btn-primary">Save</button>
            <button id="cancel-buyer-btn" type="button" class="btn btn-sm btn-secondary">Cancel</button>
          </div>
        </div>
      </div>

      <div class="col-12 col-sm-6 col-md-2">
        <label for="manual-item-id" class="form-label">Item</label>
        <div class="d-flex">
          {{ manual_form.item_id(class="form-select form-select-sm w-100", id="manual-item-id") }}
          <button id="add-item-btn" type="button"
                  class="btn btn-outline-secondary btn-sm ms-1">+</button>
        </div>
        <div id="add-item-form" class="mt-1" style="display:none;">
          <input type="text" id="new-item-name"
                 class="form-control form-control-sm"
                 placeholder="New item name">
          <div class="mt-1">
            <button id="save-item-btn" type="button" class="btn btn-sm btn-primary">Save</button>
            <button id="cancel-item-btn" type="button" class="btn btn-sm btn-secondary">Cancel</button>
          </div>
        </div>
      </div>

      <div class="col-12 col-sm-4 col-md-2">
        <label class="form-label">Price</label>
        {{ manual_form.total_price(class="form-control form-control-sm", placeholder="₪") }}
      </div>

      <div class="col-6 col-sm-4 col-md-1">
        <label class="form-label">Qty</label>
        {{ manual_form.quantity(class="form-control form-control-sm", placeholder="Qty") }}
      </div>

      <div class="col-6 col-sm-4 col-md-3">
        <label class="form-label">Notes</label>
        {{ manual_form.manual_entry_notes(
            class="form-control form-control-sm", placeholder="Notes", rows="1"
        ) }}
      </div>

      <div class="col-12 col-sm-6 col-md-2">
        <button id="manual-add-btn" type="button" class="btn btn-success w-100">Add</button>
      </div>
    </div>
  </form>

  <!-- Live purchases (responsive table) -->
  <h4>Current Purchases</h4>
  <div class="table-responsive mb-4">
    <table class="table table-striped">
      <thead>
        <tr>
          <th>Buyer</th>
          <th>Item</th>
          <th>Price</th>
          <th>Qty</th>
          <th>Notes</th>
          <th>Time</th>
          <th></th>
        </tr>
      </thead>
      <tbody id="purchase-table-body"></tbody>
    </table>
  </div>

  <!-- Finish button -->
  <form method="POST"
        action="{{ url_for('scanning.finish_event') }}"
        onsubmit="return confirm('Finish scanning? Pending item will save.');">
    <button class="btn btn-success">Finish Event Scanning</button>
  </form>
</div>

<script>
  // Fetch & render current purchases
  async function fetchPurchases() {
    const res = await fetch('{{ url_for("scanning.list_purchases") }}');
    const { purchases } = await res.json();
    const tbody = document.getElementById('purchase-table-body');
    tbody.innerHTML = '';
    purchases.forEach(p => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${p.buyer}</td>
        <td>${p.item}</td>
        <td>${p.price !== null ? '₪' + p.price.toFixed(2) : ''}</td>
        <td>${p.quantity}</td>
        <td>${p.notes}</td>
        <td>${p.time}</td>
        <td><button class="btn btn-sm btn-outline-danger">Del</button></td>
      `;
      tr.querySelector('button').onclick = async () => {
        await fetch(`/scan/purchase/${p.id}`, { method: 'DELETE' });
        fetchPurchases();
      };
      tbody.appendChild(tr);
    });
  }

  // Manual-entry “Add” button
  document.getElementById('manual-add-btn').onclick = async () => {
    const form = document.getElementById('manual-entry-form');
    const fd = new FormData(form);
    if (!fd.get('total_price').trim()) fd.set('total_price', '0');
    const res = await fetch(form.action, {
      method: 'POST',
      credentials: 'same-origin',
      body: fd
    });
    if (res.ok) {
      const buyer = fd.get('buyer_id'), item = fd.get('item_id');
      form.reset();
      form.querySelector('select[name="buyer_id"]').value = buyer;
      form.querySelector('select[name="item_id"]').value = item;
      fetchPurchases();
    } else {
      const err = await res.json();
      alert('Error adding purchase: ' + JSON.stringify(err.errors || err));
    }
  };

  // Inline Add Buyer
  const buyerSelect = document.getElementById('manual-buyer-id');
  document.getElementById('add-buyer-btn').onclick = () => {
    document.getElementById('add-buyer-form').style.display = 'block';
    buyerSelect.parentElement.style.display = 'none';
  };
  document.getElementById('cancel-buyer-btn').onclick = () => {
    document.getElementById('add-buyer-form').style.display = 'none';
    buyerSelect.parentElement.style.display = 'flex';
  };
  document.getElementById('save-buyer-btn').onclick = async () => {
    const name = document.getElementById('new-buyer-name').value.trim();
    if (!name) { alert('Name required'); return; }
    const res = await fetch('{{ url_for("scanning.add_buyer") }}', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ name })
    });
    if (res.ok) {
      const b = await res.json();
      buyerSelect.add(new Option(b.name, b.id, true, true));
      document.getElementById('add-buyer-form').style.display = 'none';
      buyerSelect.parentElement.style.display = 'flex';
    } else {
      const err = await res.json();
      alert('Error adding buyer: ' + JSON.stringify(err.error || err));
    }
  };

  // Inline Add Item
  const itemSelect = document.getElementById('manual-item-id');
  document.getElementById('add-item-btn').onclick = () => {
    document.getElementById('add-item-form').style.display = 'block';
    itemSelect.parentElement.style.display = 'none';
  };
  document.getElementById('cancel-item-btn').onclick = () => {
    document.getElementById('add-item-form').style.display = 'none';
    itemSelect.parentElement.style.display = 'flex';
  };
  document.getElementById('save-item-btn').onclick = async () => {
    const name = document.getElementById('new-item-name').value.trim();
    if (!name) { alert('Name required'); return; }
    const res = await fetch('{{ url_for("scanning.add_item") }}', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ name })
    });
    if (res.ok) {
      const it = await res.json();
      itemSelect.add(new Option(it.name, it.id, true, true));
      document.getElementById('add-item-form').style.display = 'none';
      itemSelect.parentElement.style.display = 'flex';
    } else {
      const err = await res.json();
      alert('Error adding item: ' + JSON.stringify(err.error || err));
    }
  };

  // Initial load
  window.addEventListener('DOMContentLoaded', fetchPurchases);
</script>
{% endblock %}
